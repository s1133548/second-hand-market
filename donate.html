<!-- File: donate.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Donate - Second Hand Market</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="donate.html">Donate</a>
    <a href="sell.html">Sell</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
  </nav>

  <main class="container">
    <h2>Donate an Item</h2>

    <form id="donateForm">
      <input type="text" id="name" placeholder="Full Name" required />
      <input type="email" id="email" placeholder="Email address" required />
      <input type="text" id="item" placeholder="Item name" required />
      <select id="category" required>
        <option value="">Select category</option>
        <option>Clothes</option>
        <option>Electronics</option>
        <option>Furniture</option>
        <option>Books</option>
        <option>Other</option>
      </select>
      <textarea id="description" rows="4" placeholder="Short description" required></textarea>

      <label class="file-label">
        <input type="file" id="image" accept="image/*" required />
        <span>Select an image (max 5 MB)</span>
      </label>

      <button id="submitBtn" type="submit">Donate Now</button>
      <p id="status" class="status"></p>
    </form>
  </main>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Firebase modular SDKs (type=module) -->
  <script type="module">
    // ---- 1) FIREBASE SETUP (Realtime Database) ----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref as dbRef, push, set } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    // TODO: Paste YOUR Firebase config object here (copy from Firebase Console -> Project settings -> Your apps)
    const firebaseConfig = {
      apiKey: "AIzaSyDr1I8gvzidt-RTFCDuLvv_pxwjUQpuvVg"",
      authDomain: "second-hand-market-ac9f1.firebaseapp.com",
      databaseURL: "https://second-hand-market-ac9f1-default-rtdb.firebaseio.com",
      projectId: "second-hand-market-ac9f1",
      storageBucket: "second-hand-market-ac9f1.firebasestorage.app",
      messagingSenderId: "346650617019",
      appId: "1:346650617019:web:2ed646f43df061ec72b59e"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const db = getDatabase(firebaseApp);

    // ---- 2) SUPABASE SETUP ----
    // TODO: Replace with your Supabase project values
    // Create a free Supabase project at https://supabase.com -> Project Settings -> API
    const SUPABASE_URL = "https://jdxdqmggyxhdycfmvygw.supabase.co";

    // create the client (global 'supabase' object comes from the CDN)
    const supabase = supabase.createClient(https://jdxdqmggyxhdycfmvygw.supabase.co, eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkeGRxbWdneXhoZHljZm12eWd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTAxNzYsImV4cCI6MjA3OTA2NjE3Nn0.HFwu8W_oAsY-enrdYbe-pqBYaWY6TECAruW-yINYNrE);

    // ---- 3) Helper: upload image to Supabase Storage and return public URL ----
    async function uploadImageToSupabase(file) {
      // create a unique filename to avoid collisions
      const fileExt = file.name.split('.').pop();
      const fileName = `${Date.now()}-${Math.floor(Math.random() * 10000)}.${fileExt}`;
      const bucket = 'donations'; // make sure you created this bucket in Supabase Storage and set it to public

      // upload
      const { data, error } = await supabase.storage.from(bucket).upload(fileName, file, {
        cacheControl: '3600',
        upsert: false
      });

      if (error) {
        throw error;
      }

      // get public URL
      const { data: urlData } = supabase.storage.from(bucket).getPublicUrl(fileName);
      return urlData.publicUrl;
    }

    // ---- 4) Form handling ----
    const form = document.getElementById('donateForm');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = '';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Uploading...';

      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const item = document.getElementById('item').value.trim();
      const category = document.getElementById('category').value;
      const description = document.getElementById('description').value.trim();
      const imageFile = document.getElementById('image').files[0];

      if (!imageFile) {
        statusEl.textContent = 'Please choose an image file.';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Donate Now';
        return;
      }

      if (imageFile.size > 5 * 1024 * 1024) {
        statusEl.textContent = 'Image too large â€” maximum 5 MB.';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Donate Now';
        return;
      }

      try {
        statusEl.textContent = 'Uploading image...';
        const imageURL = await uploadImageToSupabase(imageFile);

        statusEl.textContent = 'Saving donation...';
        // write to Firebase Realtime Database
        const donationsRef = dbRef(db, 'donations');
        const newDonationRef = push(donationsRef);
        await set(newDonationRef, {
          name,
          email,
          item,
          category,
          description,
          imageURL,
          timestamp: new Date().toISOString()
        });

        statusEl.textContent = 'Thank you! Donation submitted.';
        form.reset();
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error: ' + (err.message || 'Upload or save failed.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Donate Now';
      }
    });
  </script>
</body>
</html>
