<!-- Firebase v9 (modular) and Supabase (ESM) -->
<script type="module">
  // ======== CONFIG: USING YOUR REAL KEYS ========
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDr1I8gvzidt-RTFCDuLvv_pxwjUQpuvVg",
    authDomain: "second-hand-market-ac9f1.firebaseapp.com",
    projectId: "second-hand-market-ac9f1",
    storageBucket: "second-hand-market-ac9f1.firebasestorage.app",
    messagingSenderId: "346650617019",
    appId: "1:346650617019:web:2ed646f43df061ec72b59e"
  };

  const SUPABASE_URL = "https://jdxdqmggyxhdycfmvygw.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkeGRxbWdneXhoZHljZm12eWd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTAxNzYsImV4cCI6MjA3OTA2NjE3Nn0.HFwu8W_oAsY-enrdYbe-pqBYaWY6TECAruW-yINYNrE";
  // =======================================================================

  // Import Firebase SDK functions
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

  // Import Supabase
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // Initialize Firebase
  const app = initializeApp(FIREBASE_CONFIG);
  const auth = getAuth(app);
  const storage = getStorage(app);

  // Initialize Supabase
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // DOM nodes
  const form = document.getElementById('donateForm');
  const imageInput = document.getElementById('imageUpload');
  const chooseBtn = document.getElementById('chooseBtn');
  const fileName = document.getElementById('fileName');
  const submitBtn = document.getElementById('submitBtn');
  const loadingText = document.getElementById('loading');
  const msgBox = document.getElementById('msg');

  // Choose file button behaviour
  chooseBtn.addEventListener('click', () => imageInput.click());
  imageInput.addEventListener('change', () => {
    const f = imageInput.files[0];
    fileName.textContent = f ? f.name : 'Choose an image (max 5 MB)';
  });

  // helper to show messages
  function showMessage(type, text) {
    msgBox.innerHTML = `<div class="alert ${type === 'success' ? 'success' : 'error'}">${text}</div>`;
    setTimeout(()=> { msgBox.innerHTML = ''; }, 6000);
  }

  // Sign in anonymously to Firebase
  async function ensureAnonymousAuth() {
    if (!auth.currentUser) {
      try {
        await signInAnonymously(auth);
        console.log('Signed in anonymously to Firebase');
      } catch (err) {
        console.error('Firebase anonymous sign-in failed', err);
        throw err;
      }
    }
  }

  // Upload image to Firebase Storage
  async function uploadImageAndGetUrl(file) {
    if (!file) return null;
    if (file.size > 5 * 1024 * 1024) throw new Error('Image too large. Max 5 MB.');

    const timestamp = Date.now();
    const cleanName = file.name.replace(/\s+/g,'_');
    const path = `items/${timestamp}_${cleanName}`;
    const sRef = storageRef(storage, path);

    return new Promise((resolve, reject) => {
      const uploadTask = uploadBytesResumable(sRef, file);
      uploadTask.on('state_changed',
        (snapshot) => {},
        (error) => reject(error),
        async () => {
          try {
            const url = await getDownloadURL(uploadTask.snapshot.ref);
            resolve(url);
          } catch (e) {
            reject(e);
          }
        }
      );
    });
  }

  // Main form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    loadingText.style.display = 'inline';
    msgBox.innerHTML = '';

    try {
      const donor_name = document.getElementById('fullName').value.trim();
      const donor_email = document.getElementById('email').value.trim();
      const name = document.getElementById('itemName').value.trim();
      const category = document.getElementById('category').value;
      const location = document.getElementById('location').value.trim();
      const priceRaw = document.getElementById('price').value;
      const price = parseFloat(priceRaw) || 0;
      const description = document.getElementById('description').value.trim();

      if (!donor_name || !donor_email || !name || !category || !location) {
        throw new Error('Please fill all required fields.');
      }

      await ensureAnonymousAuth();

      const file = imageInput.files[0];
      let image_url = null;
      if (file) {
        image_url = await uploadImageAndGetUrl(file);
      }

      const type = (price === 0) ? 'Donation' : 'For Sale';

      const row = {
        name,
        description,
        category,
        price,
        location,
        image_url,
        donor_name,
        donor_email,
        type
      };

      const { data, error } = await supabase
        .from('items')
        .insert([row]);

      if (error) {
        console.error('Supabase insert error', error);
        throw new Error('Failed to save item. ' + (error.message || ''));
      }

      form.reset();
      fileName.textContent = 'Choose an image (max 5 MB)';
      showMessage('success', `Item saved as "${type}". Thank you!`);

    } catch (err) {
      console.error(err);
      showMessage('error', err.message || 'An error occurred.');
    } finally {
      submitBtn.disabled = false;
      loadingText.style.display = 'none';
    }
  });

</script>
