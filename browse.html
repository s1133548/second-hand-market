<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Browse Items â€” Second-Hand Market</title>
  <style>
    :root{
      --accent:#2f8f4f;
      --muted:#9aa7ad;
      --card-bg:#fff;
      --page-bg:#f4f7f8;
      --btn-gray:#e9edf0;
      --maxw:1100px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--page-bg);
      color:#163033;
      padding:20px;
      display:flex;
      justify-content:center;
    }
    .page{
      width:100%;
      max-width:var(--maxw);
    }
    header{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-bottom:18px;
    }

    /* Search row */
    .search-row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .search-label{
      font-weight:600;
      min-width:64px;
    }
    .search-box{
      flex:1;
      display:flex;
      align-items:center;
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      border:1px solid #e3eaec;
      box-shadow:0 1px 0 rgba(0,0,0,0.02);
    }
    .search-input{
      border:0;
      outline:none;
      font-size:15px;
      width:100%;
      background:transparent;
    }
    .suggestions {
      margin-left:8px;
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
      opacity:.85;
    }

    /* Category bar */
    .cat-bar-wrap{
      margin-top:6px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:8px;
    }
    .cat-bar{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .cat-btn{
      flex:0 0 auto;
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid transparent;
      background:var(--btn-gray);
      cursor:pointer;
      font-weight:600;
      color:#23353a;
      white-space:nowrap;
      box-shadow:0 2px 6px rgba(11,22,24,0.03);
      transition: all .15s ease;
    }
    .cat-btn .icon { font-size:16px; }
    .cat-btn.selected{
      background:var(--accent);
      color:#fff;
      transform:translateY(-2px);
      box-shadow:0 8px 18px rgba(47,143,79,0.18);
    }

    /* Grid */
    .items-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:16px;
      margin-top:18px;
    }
    .card{
      background:var(--card-bg);
      border-radius:12px;
      padding:12px;
      box-shadow:0 6px 16px rgba(10,25,30,0.04);
      cursor:pointer;
      transition:transform .14s ease;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .card:hover{ transform:translateY(-6px); }
    .card img{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:8px;
      background:#f0f3f5;
    }
    .card .title{font-size:16px;font-weight:700;color:#152628;margin:0}
    .card .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .price{font-weight:800;color:var(--accent)}
    .location{font-size:13px;color:var(--muted)}

    /* Modal */
    .modal-bg{
      position:fixed;inset:0;
      display:none;
      justify-content:center;
      align-items:center;
      background:rgba(0,0,0,0.55);
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:540px;
      background:#fff;
      border-radius:12px;
      padding:18px;
      position:relative;
      box-shadow:0 18px 60px rgba(10,18,20,0.3);
      max-height:90vh;
      overflow:auto;
    }
    .close-x{
      position:absolute;right:12px;top:12px;background:#000;color:#fff;border-radius:999px;padding:6px 10px;cursor:pointer;font-weight:700;
    }
    .modal img{width:100%;height:260px;object-fit:cover;border-radius:8px;margin-bottom:10px}
    .modal h2{margin:4px 0 8px}
    .modal .row{display:flex;gap:10px;flex-wrap:wrap}
    .modal label{display:block;font-weight:600;margin-top:10px}
    #pickupDate{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0;margin-top:6px}
    #getBtn{width:100%;margin-top:12px;padding:12px;border-radius:10px;background:var(--accent);color:#fff;border:0;font-weight:700;cursor:pointer}
    #getBtn[disabled]{opacity:.6;cursor:default}

    /* small top bar with proposal link */
    .top-links{display:flex;justify-content:flex-end;gap:12px;margin-bottom:10px}
    .link-btn{background:#fff;padding:8px 12px;border-radius:10px;border:1px solid #e6eef0;font-weight:600;cursor:pointer;text-decoration:none;color:#133132}

    @media (max-width:600px){
      .modal img{height:180px}
      .card img{height:130px}
      .search-row{gap:8px}
      .search-label{min-width:56px;font-size:14px}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="top-links">
      <!-- local path to the uploaded project proposal file (you uploaded this earlier) -->
      <a class="link-btn" href="/mnt/data/SECOND HAND MARKET WEB APP Final_compressed 1.pdf" target="_blank">donate, ease life</a>
    </div>

    <header>
      <div class="search-row">
        <div class="search-label">Search:</div>
        <div class="search-box" role="search">
          <input id="searchInput" class="search-input" type="search" placeholder="" aria-label="Search items by name, location, or keyword">
          <div class="suggestions" id="suggestionText" aria-hidden="true"></div>
        </div>
      </div>

      <div class="cat-bar-wrap">
        <div id="catBar" class="cat-bar">
          <!-- category buttons will be injected here -->
        </div>
      </div>
    </header>

    <main>
      <div id="itemsGrid" class="items-grid"></div>
    </main>
  </div>

  <!-- Modal -->
  <div id="modalBg" class="modal-bg" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <div class="close-x" id="closeX">X</div>
      <img id="modalImg" src="" alt="Item image">
      <h2 id="modalName"></h2>

      <div class="row">
        <div><strong>Category:</strong> <span id="modalCategory"></span></div>
        <div><strong>Price:</strong> <span id="modalPrice"></span></div>
      </div>

      <p style="margin-top:8px"><strong>Location:</strong> <span id="modalLocation"></span></p>
      <p><strong>Description:</strong> <span id="modalDesc"></span></p>
      <p><strong>Donor:</strong> <span id="modalDonor"></span> â€” <a id="modalEmail" href=""></a></p>

      <label for="pickupDate">Select pickup day (within 7 days)</label>
      <input id="pickupDate" type="date" />

      <button id="getBtn">Get Item</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ===== Supabase config (your project) =====
    const SUPABASE_URL = "https://jdxdqmggyxhdycfmvygw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkeGRxbWdneXhoZHljZm12eWd3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0OTAxNzYsImV4cCI6MjA3OTA2NjE3Nn0.HFwu8W_oAsY-enrdYbe-pqBYaWY6TECAruW-yINYNrE";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // ==========================================

    // Categories with icons (emojis)
    const CATEGORIES = [
      { key: "", label: "All", icon: "ðŸ”Ž" },
      { key: "Clothes", label: "Clothes", icon: "ðŸ‘•" },
      { key: "Electronics", label: "Electronics", icon: "ðŸ’»" },
      { key: "Furniture", label: "Furniture", icon: "ðŸ›‹" },
      { key: "Kitchenware", label: "Kitchenware", icon: "ðŸ½" },
      { key: "Books", label: "Books", icon: "ðŸ“š" },
      { key: "Other", label: "Other", icon: "ðŸ“¦" }
    ];

    // DOM
    const catBar = document.getElementById('catBar');
    const itemsGrid = document.getElementById('itemsGrid');
    const searchInput = document.getElementById('searchInput');
    const suggestionText = document.getElementById('suggestionText');

    // modal nodes
    const modalBg = document.getElementById('modalBg');
    const closeX = document.getElementById('closeX');
    const modalImg = document.getElementById('modalImg');
    const modalName = document.getElementById('modalName');
    const modalCategory = document.getElementById('modalCategory');
    const modalPrice = document.getElementById('modalPrice');
    const modalLocation = document.getElementById('modalLocation');
    const modalDesc = document.getElementById('modalDesc');
    const modalDonor = document.getElementById('modalDonor');
    const modalEmail = document.getElementById('modalEmail');
    const pickupDate = document.getElementById('pickupDate');
    const getBtn = document.getElementById('getBtn');

    // App state
    let allItems = [];
    let filteredItems = [];
    let selectedCategory = "";
    let selectedItem = null;

    // --- Recent searches (localStorage) ---
    const RECENT_KEY = 'shm_recent_searches';
    function getRecentSearches(){
      try{
        const raw = localStorage.getItem(RECENT_KEY);
        if(!raw) return [];
        return JSON.parse(raw);
      }catch(e){ return []; }
    }
    function addRecentSearch(q){
      if(!q) return;
      q = q.trim();
      if(!q) return;
      let arr = getRecentSearches();
      // remove duplicates and add to front
      arr = arr.filter(x => x.toLowerCase() !== q.toLowerCase());
      arr.unshift(q);
      if(arr.length > 6) arr = arr.slice(0,6);
      localStorage.setItem(RECENT_KEY, JSON.stringify(arr));
    }

    // --- Rotating placeholder text (categories + recent searches) ---
    let suggestions = [];
    function buildSuggestions(){
      const recent = getRecentSearches();
      const catNames = CATEGORIES.filter(c=>c.key!=="").map(c=>c.label);
      suggestions = [...recent, ...catNames];
      if(suggestions.length===0) suggestions = catNames;
    }
    buildSuggestions();

    let suggestionIndex = 0;
    function rotateSuggestion(){
      if(!suggestions || suggestions.length===0) { suggestionText.textContent = ""; return; }
      suggestionText.textContent = suggestions[suggestionIndex % suggestions.length];
      suggestionIndex++;
    }
    // rotate every 2.2 seconds
    rotateSuggestion();
    setInterval(rotateSuggestion, 2200);

    // Render category bar
    function renderCategories(){
      catBar.innerHTML = '';
      CATEGORIES.forEach(cat=>{
        const btn = document.createElement('button');
        btn.className = 'cat-btn' + (cat.key === selectedCategory ? ' selected' : '');
        btn.innerHTML = `<span class="icon">${cat.icon}</span><span>${cat.label}</span>`;
        btn.onclick = () => {
          selectedCategory = cat.key;
          // reset search input when category clicked? we'll keep search as-is to allow combined filtering
          renderCategories();
          applyFilters();
        };
        catBar.appendChild(btn);
      });
    }
    renderCategories();

    // Load items from Supabase
    async function loadItems(){
      try{
        const { data, error } = await supabase.from('items').select('*').order('created_at', { ascending:false });
        if(error){ console.error('loadItems error', error); return; }
        allItems = data || [];
        applyFilters();
      }catch(err){
        console.error(err);
      }
    }
    await loadItems();

    // Apply filters: category + search text
    function applyFilters(){
      const q = (searchInput.value || '').toLowerCase().trim();
      filteredItems = allItems.filter(it=>{
        // category check
        const catOk = (!selectedCategory) || (it.category === selectedCategory);
        // search check: name, description, location, donor
        const text = ((it.name||'') + ' ' + (it.description||'') + ' ' + (it.location||'') + ' ' + (it.donor_name||'')).toLowerCase();
        const searchOk = q === '' || text.includes(q);
        return catOk && searchOk;
      });
      renderItems(filteredItems);
    }

    // render items grid
    function renderItems(items){
      itemsGrid.innerHTML = '';
      if(!items || items.length===0){
        itemsGrid.innerHTML = `<div style="grid-column:1/-1;padding:28px;text-align:center;color:var(--muted)">No items found.</div>`;
        return;
      }
      items.forEach(item=>{
        const card = document.createElement('div');
        card.className = 'card';
        const imgSrc = item.image_url || '';
        card.innerHTML = `
          <img src="${imgSrc}" alt="${escapeHtml(item.name)}">
          <div>
            <div class="title">${escapeHtml(item.name)}</div>
            <div class="meta">
              <div class="price">${item.price==0 ? 'Free' : ('$' + parseFloat(item.price).toFixed(2))}</div>
              <div class="location">${escapeHtml(item.location || '')}</div>
            </div>
          </div>
        `;
        card.onclick = () => openModal(item);
        itemsGrid.appendChild(card);
      });
    }

    // search input events
    searchInput.addEventListener('input', () => {
      applyFilters();
    });

    // enter key saves to recent searches
    searchInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        const v = searchInput.value.trim();
        addRecentSearch(v);
        buildSuggestions();
      }
    });

    // clicking suggestion text fills input
    suggestionText.addEventListener('click', () => {
      if(suggestionText.textContent) {
        searchInput.value = suggestionText.textContent;
        addRecentSearch(suggestionText.textContent);
        buildSuggestions();
        applyFilters();
      }
    });

    // Helper to escape HTML
    function escapeHtml(str){
      if(!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // --- Modal logic ---
    function openModal(item){
      selectedItem = item;
      modalImg.src = item.image_url || '';
      modalName.textContent = item.name || '';
      modalCategory.textContent = item.category || '';
      modalPrice.textContent = item.price==0 ? 'Free' : ('$' + parseFloat(item.price).toFixed(2));
      modalLocation.textContent = item.location || '';
      modalDesc.textContent = item.description || '';
      modalDonor.textContent = item.donor_name || '';
      modalEmail.textContent = item.donor_email || '';
      modalEmail.href = `mailto:${item.donor_email || ''}`;

      // pickup date range within 7 days
      const today = new Date();
      const min = today.toISOString().split('T')[0];
      const maxDate = new Date(); maxDate.setDate(today.getDate()+7);
      const max = maxDate.toISOString().split('T')[0];
      pickupDate.min = min;
      pickupDate.max = max;
      pickupDate.value = min;

      getBtn.disabled = false;
      modalBg.style.display = 'flex';
    }

    function closeModal(){
      modalBg.style.display = 'none';
      selectedItem = null;
    }

    closeX.addEventListener('click', closeModal);
    modalBg.addEventListener('click', (e)=>{
      if(e.target === modalBg) closeModal();
    });

    // --- Get Item (delete) ---
    getBtn.addEventListener('click', async ()=>{
      if(!selectedItem) return;
      const dateVal = pickupDate.value;
      if(!dateVal){
        alert('Please choose a pickup date within 7 days.');
        return;
      }

      // Optionally: you might want to create a "reservations" table instead of deleting,
      // but as requested we'll remove the item from the listing (delete).
      try{
        getBtn.disabled = true;
        const { error } = await supabase.from('items').delete().eq('id', selectedItem.id);
        if(error){
          console.error('Delete failed', error);
          alert('Failed to reserve item. Try again.');
          getBtn.disabled = false;
          return;
        }

        // success - remove from local list and refresh UI
        allItems = allItems.filter(i => i.id !== selectedItem.id);
        applyFilters();

        // Optionally we can save a local "reservation" record in localStorage for the user
        // so they can see what they reserved. We'll add a small local note:
        const rs = JSON.parse(localStorage.getItem('shm_my_reservations') || '[]');
        rs.unshift({ id:selectedItem.id, name:selectedItem.name, pickup: dateVal, reserved_at:(new Date()).toISOString() });
        localStorage.setItem('shm_my_reservations', JSON.stringify(rs.slice(0,20)));

        alert('Success! Item reserved for pickup on ' + dateVal + '. The item has been removed from listings.');
        closeModal();
      }catch(err){
        console.error(err);
        alert('An error occurred while reserving the item.');
        getBtn.disabled = false;
      }
    });

    // utility: refresh suggestions when recent searches change (exposed)
    window.refreshSHMSuggestions = () => { buildSuggestions(); suggestionIndex = 0; rotateSuggestion(); };

    // helper: reload items when coming back to this page if needed
    window.reloadSHMItems = async () => { await loadItems(); };

    // initial UI render (categories already rendered earlier)
    // ensure horizontal scroll snaps to selected
    function scrollSelectedIntoView(){
      const sel = document.querySelector('.cat-btn.selected');
      if(sel && catBar) sel.scrollIntoView({inline:'center', behavior:'smooth'});
    }

    // whenever categories change, scroll selected into view
    const observer = new MutationObserver(()=> scrollSelectedIntoView());
    observer.observe(catBar, { childList:true, subtree:true });

    // small accessibility: pressing Escape closes modal
    document.addEventListener('keydown', (e)=> {
      if(e.key === 'Escape' && modalBg.style.display === 'flex') closeModal();
    });

    // ensure suggestions array is kept up-to-date when start
    buildSuggestions();

    // End of module script
  </script>
</body>
</html>
